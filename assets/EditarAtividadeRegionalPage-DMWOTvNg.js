import{j as e}from"./ui-C_BmRRy8.js";import{r as a}from"./vendor-Psgnp9ei.js";import{u as s}from"./query-BI71cv7L.js";import{B as i}from"./Button-DjYkO9ZW.js";import{C as t}from"./Card-C21MRrmW.js";import{u as r,N as o}from"./NotificationModal-DxK041da.js";import{b as l,A as n,P as d,R as c,S as m}from"./constants-CdNJpgjE.js";import{b as g,A as u}from"./index-_MdAt-zn.js";import{d as x,a as v}from"./router-DVMx2JKX.js";import{v as h,m as p,l as b,O as f,o as j,U as y,e as N,x as w,Z as C,X as k,_ as A}from"./icons-sb5RvF5O.js";import"./supabase-CfsjXCJe.js";import"./forms-BADiA78i.js";import"./utils-CwAUyRUs.js";import"./charts-C4lFoNLr.js";function S(){const{id:S}=x(),E=v(),q=s(),[L,z]=a.useState({atividade:"",atividadeLabel:"",atividadeCustomLabel:"",responsavel:"",descricao:"",dataAtividade:"",regional:"nacional",estados:[],programa:"",instituicaoId:"",evidencias:[],quantidade:void 0}),[P,$]=a.useState([]),[I,O]=a.useState([]),[T,_]=a.useState(""),[B,D]=a.useState(!0),[G,J]=a.useState(!1),[M,R]=a.useState([]),[F,Q]=a.useState(!1),[U,K]=a.useState({type:"success",title:"",message:""}),{data:V}=g();r();const W={nacional:["nacional"],centroeste:["centroeste","centro-oeste","centrooeste"],nordeste:["nordeste"],norte:["norte"],rj:["rj","riodejaneiro"],sp:["sp","saopaulo"],sul:["sul"]},Z=(V||[]).filter(e=>{const a=(e.area||e.regional||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const s=(W[L.regional]||[]).some(e=>a.includes(e)),i="nacional"===a;return"nacional"===L.regional?s||i:s}).sort((e,a)=>(e.nome||e.email||"").localeCompare(a.nome||a.email||""));a.useEffect(()=>{(async()=>{var e;if(S)try{const a=localStorage.getItem("auth_token");if(!a)return void E("/login");const s=await fetch(`${u}/api/regional-activities/${S}/with-files`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(!s.ok)throw new Error("Atividade não encontrada");const i=await s.json();let t=[];if("string"==typeof i.estados)try{t=JSON.parse(i.estados)}catch{t=[]}else Array.isArray(i.estados)&&(t=i.estados);z({atividade:i.tipo||"",atividadeLabel:i.titulo||"",atividadeCustomLabel:"",responsavel:(null==(e=i.responsavel)?void 0:e.id)||"",descricao:i.descricao||"",dataAtividade:i.data_inicio?i.data_inicio.split("T")[0]:"",regional:i.regional||"nacional",estados:t,programa:i.programa||"",instituicaoId:i.instituicao_id||"",evidencias:i.evidencias||[],quantidade:i.quantidade})}catch(a){K({type:"error",title:"Erro ao carregar atividade",message:"Não foi possível carregar os dados da atividade."}),Q(!0),E("/regionais/gestao-atividades")}finally{D(!1)}})()},[S,E]),a.useEffect(()=>{(async()=>{try{const e=localStorage.getItem("auth_token");if(!e)return;const a=await fetch(`${u}/api/ongs`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(a.ok){const e=((await a.json()).data||[]).filter(e=>"norte"===e.regional);O(e)}}catch(e){}})()},[]);const H=()=>{E("/regionais/gestao-atividades")};return B?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando atividade..."})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 p-4",children:[e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"flex items-center gap-4 mb-4",children:e.jsxs("button",{onClick:H,className:"flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors",children:[e.jsx(h,{className:"w-5 h-5"}),"Voltar"]})}),e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(p,{className:"w-6 h-6 text-orange-500"}),"Editar Atividade Regional"]})]}),e.jsx(t,{className:"p-6",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),L.atividade&&L.dataAtividade){J(!0);try{const e=localStorage.getItem("auth_token");if(!e)return void E("/login");const a={title:"OUTRA"===L.atividadeLabel&&L.atividadeCustomLabel.trim()?L.atividadeCustomLabel.trim():L.atividadeLabel||L.atividade,description:L.descricao||"",type:L.atividade,activity_date:L.dataAtividade,responsavel_id:L.responsavel||null,regional:L.regional,programa:L.programa||"",estados:L.estados||[],instituicaoId:L.instituicaoId||"",quantidade:L.quantidade||null,atividadeLabel:L.atividadeLabel||"",atividadeCustomLabel:L.atividadeCustomLabel||"",evidencias:L.evidencias||[]};if(M.length>0){const s=new FormData;Object.keys(a).forEach(e=>{const i=a[e];null!=i&&(Array.isArray(i)?s.append(e,JSON.stringify(i)):s.append(e,String(i)))}),M.forEach(e=>{s.append("evidencias",e)});const i=await fetch(`${u}/api/regional-activities/${S}/with-files`,{method:"PUT",headers:{Authorization:`Bearer ${e}`},body:s});if(!i.ok){const e=await i.json();throw new Error(e.error||"Erro ao atualizar atividade")}}else{const s=await fetch(`${u}/api/regional-activities/${S}`,{method:"PUT",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){const e=await s.json();throw new Error(e.error||"Erro ao atualizar atividade")}}q.invalidateQueries({queryKey:["regional-activities"]}),q.refetchQueries({queryKey:["regional-activities"]}),q.invalidateQueries({queryKey:["activities"]}),q.refetchQueries({queryKey:["activities"]}),K({type:"success",title:"Sucesso!",message:"Atividade atualizada com sucesso!"}),Q(!0),E("/regionais/gestao-atividades")}catch(a){K({type:"error",title:"Erro ao atualizar atividade",message:"Não foi possível atualizar a atividade. Tente novamente."}),Q(!0)}finally{J(!1)}}else alert("Por favor, preencha todos os campos obrigatórios")},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Tipo de Atividade *"}),e.jsxs("select",{value:L.atividade,onChange:e=>{const a=[...n,...P].find(a=>a.value===e.target.value);z({...L,atividade:e.target.value,atividadeLabel:(null==a?void 0:a.label)||e.target.value})},className:"w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",required:!0,children:[e.jsx("option",{value:"",children:"Selecione uma atividade"}),n.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value)),P.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})]}),"OUTRA"===L.atividadeLabel&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Nome da Atividade *"}),e.jsx("input",{type:"text",value:L.atividadeCustomLabel,onChange:e=>z({...L,atividadeCustomLabel:e.target.value}),className:"w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",placeholder:"Digite o nome da atividade",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Programa"}),e.jsxs("select",{value:L.programa,onChange:e=>z({...L,programa:e.target.value}),className:"w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",children:[e.jsx("option",{value:"",children:"Selecione um programa"}),Object.entries(d).map(([a,s])=>e.jsx("option",{value:a,children:s},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Responsável"}),e.jsxs("select",{value:L.responsavel,onChange:e=>z({...L,responsavel:e.target.value}),className:"w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",children:[e.jsx("option",{value:"",children:"Selecione um responsável"}),Z.map(a=>e.jsxs("option",{value:a.id,children:[a.nome||a.email," ",a.role&&("super_admin"===a.role?e.jsx(b,{className:"inline w-3 h-3 ml-1 text-yellow-500"}):"admin"===a.role?e.jsx(f,{className:"inline w-3 h-3 ml-1 text-blue-500"}):"member"===a.role?e.jsx(j,{className:"inline w-3 h-3 ml-1 text-green-500"}):e.jsx(y,{className:"inline w-3 h-3 ml-1 text-gray-500"}))]},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Instituição/ONG"}),e.jsxs("select",{value:L.instituicaoId,onChange:e=>z({...L,instituicaoId:e.target.value}),className:"w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",children:[e.jsx("option",{value:"",children:"Selecione uma instituição"}),I.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Regional *"}),e.jsx("select",{value:L.regional,onChange:e=>z({...L,regional:e.target.value}),className:"w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",required:!0,children:Object.entries(c).filter(([e])=>"todas"!==e).map(([a,s])=>e.jsx("option",{value:a,children:s},a))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Data da Atividade *"}),e.jsx("input",{type:"date",value:L.dataAtividade,onChange:e=>z({...L,dataAtividade:e.target.value}),className:"w-full md:max-w-[220px] border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Quantidade"}),e.jsx("input",{type:"number",value:L.quantidade||"",onChange:e=>z({...L,quantidade:e.target.value?parseInt(e.target.value):void 0}),className:"w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",placeholder:"Ex: 25"})]})]}),L.regional&&l[L.regional]&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Estados"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 max-h-32 overflow-y-auto border border-gray-200 rounded-xl p-3",children:l[L.regional].map(a=>e.jsxs("label",{className:"flex items-center space-x-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:L.estados.includes(a),onChange:e=>{e.target.checked?z({...L,estados:[...L.estados,a]}):z({...L,estados:L.estados.filter(e=>e!==a)})},className:"rounded border-gray-300 text-orange-600 focus:ring-orange-500"}),e.jsx("span",{children:m[a]||a})]},a))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Descrição"}),e.jsx("textarea",{value:L.descricao,onChange:e=>z({...L,descricao:e.target.value}),className:"w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm shadow-sm transition-colors",rows:4,placeholder:"Descreva a atividade..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Evidências"}),L.evidencias.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-600 mb-2",children:"Evidências atuais:"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:L.evidencias.map((a,s)=>e.jsx("div",{className:"relative border border-gray-200 rounded-lg p-3 bg-gray-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx(N,{className:"w-4 h-4 text-gray-500 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 truncate",children:a.nome||`Evidência ${s+1}`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a.url&&e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 text-sm",children:"Ver"}),e.jsx("button",{type:"button",onClick:()=>(e=>{const a=L.evidencias.filter((a,s)=>s!==e);z({...L,evidencias:a})})(s),className:"text-red-600 hover:text-red-800 p-1",children:e.jsx(w,{className:"w-4 h-4"})})]})]})},s))})]}),M.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-600 mb-2",children:"Novas evidências:"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:M.map((a,s)=>e.jsxs("div",{className:"relative border border-green-200 rounded-lg p-3 bg-green-50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx(C,{className:"w-4 h-4 text-green-600 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700 truncate",children:a.name})]}),e.jsx("button",{type:"button",onClick:()=>(e=>{R(a=>a.filter((a,s)=>s!==e))})(s),className:"text-red-600 hover:text-red-800 p-1",children:e.jsx(w,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[(a.size/1024/1024).toFixed(2)," MB"]})]},s))})]}),L.evidencias.length+M.length<5&&e.jsxs("div",{children:[e.jsx("input",{type:"file",id:"evidencias",multiple:!0,accept:"image/jpeg,image/jpg,image/png,image/webp",onChange:e=>(e=>{if(!e)return;const a=Array.from(e),s=[];let i=!1;L.evidencias.length+M.length+a.length>2?_("Máximo de 2 evidências permitidas no total"):(a.forEach(e=>["image/jpeg","image/jpg","image/png","image/webp"].includes(e.type)?e.size>5242880?(i=!0,void _("Cada arquivo deve ter no máximo 5MB")):void s.push(e):(i=!0,void _("Apenas arquivos JPG, JPEG, PNG e WebP são permitidos"))),i||(R(e=>[...e,...s]),_("")))})(e.target.files),className:"hidden"}),e.jsxs("label",{htmlFor:"evidencias",className:"inline-flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 cursor-pointer transition-colors",children:[e.jsx(C,{className:"w-4 h-4"}),"Adicionar Evidências"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Máximo 2 evidências. Formatos: JPG, PNG, WebP. Tamanho máximo: 5MB cada."})]}),T&&e.jsx("p",{className:"text-red-600 text-sm mt-2",children:T})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsxs(i,{type:"button",variant:"outline",onClick:H,disabled:G,children:[e.jsx(k,{className:"w-4 h-4 mr-2"}),"Cancelar"]}),e.jsxs(i,{type:"submit",disabled:G,className:"bg-orange-600 hover:bg-orange-700",children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),G?"Salvando...":"Salvar Alterações"]})]})]})})]}),e.jsx(o,{isOpen:F,onClose:()=>Q(!1),type:U.type,title:U.title,message:U.message})]})}export{S as default};

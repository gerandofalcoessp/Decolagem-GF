import{j as e}from"./ui-C_BmRRy8.js";import{r as a}from"./vendor-Psgnp9ei.js";import{C as r}from"./Card-D0NYs6mj.js";import{B as s}from"./Button-DPj5z5IW.js";import{g as o,I as t}from"./index-3h40CfT8.js";import{a as l,u as n,d as c}from"./router-DVMx2JKX.js";import{B as i,_ as d}from"./icons-sb5RvF5O.js";import"./query-BI71cv7L.js";import"./supabase-CfsjXCJe.js";import"./forms-BADiA78i.js";import"./utils-CwAUyRUs.js";import"./charts-C4lFoNLr.js";function m(){var m,u;const p=l(),g=n(),{id:x}=c(),f=!!x,h=null==(m=g.state)?void 0:m.ong,[j,v]=a.useState(!1),[b,y]=a.useState(!1),[N,C]=a.useState(null),[w,k]=a.useState({}),[$,E]=a.useState(null),{showSuccess:S,showError:_}=o(),P=a.useMemo(()=>{if(f&&h)return h.regional;return new URLSearchParams(g.search).get("regional")||"nacional"},[g.search,f,h]),[B,A]=a.useState({nome:"",cnpj:"",endereco:"",cidade:"",estado:"",cep:"",telefone:"",email:"",regional:P,programas:[],status:"ativa",observacoes:"",nome_lider:"",documentos:[]});a.useEffect(()=>{if(f&&h)A(h);else if(f&&x){(async()=>{try{const e=await t.getInstituicaoById(x);A({nome:e.nome,cnpj:e.cnpj,endereco:e.endereco,cidade:e.cidade,estado:e.estado,cep:e.cep,telefone:e.telefone,email:e.email,regional:e.regional,programas:e.programas||(e.programa?[e.programa]:[]),status:e.status,observacoes:e.observacoes||"",nome_lider:e.nome_lider,documentos:e.documentos||[]})}catch(e){_("Erro ao carregar dados da instituição"),p("/ongs")}})()}},[f,h,x,_,p]);const G=e=>(e||"").replace(/\D/g,""),I=(e,a)=>{switch(e){case"cnpj":return(e=>{const a=G(e);return a&&14!==a.length?"CNPJ deve ter 14 dígitos":""})(a);case"cep":return(e=>{const a=G(e);return a?8===a.length?"":"CEP deve ter 8 dígitos":""})(a);case"telefone":return(e=>{const a=G(e).length;return a?10===a||11===a?"":"Telefone deve ter 10 ou 11 dígitos":""})(a);case"email":return(r=a)?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)?"":"Email inválido":"";default:return""}var r},O=(e,a)=>{let r=a;if("cnpj"===e&&"string"==typeof a&&(r=(e=>{const a=G(e).slice(0,14);let r=a;return a.length>2&&(r=a.replace(/^(\d{2})(\d)/,"$1.$2")),a.length>5&&(r=r.replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3")),a.length>8&&(r=r.replace(/\.(\d{3})(\d)/,".$1/$2")),a.length>12&&(r=r.replace(/\/(\d{4})(\d{1,2})$/,"/$1-$2")),r})(a)),"cep"===e&&"string"==typeof a&&(r=(e=>G(e).slice(0,8).replace(/^(\d{5})(\d)/,"$1-$2"))(a)),"telefone"===e&&"string"==typeof a&&(r=(e=>{const a=G(e).slice(0,11);return a.length<=10?a.replace(/^(\d{2})(\d)/,"($1) $2").replace(/(\d{4})(\d)/,"$1-$2"):a.replace(/^(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2")})(a)),A(a=>({...a,[e]:r})),["cnpj","cep","telefone","email"].includes(e)&&"string"==typeof r){const a=I(e,r);k(r=>({...r,[e]:a}))}"nome"===e&&w.nome&&k(e=>({...e,nome:""})),"programas"===e&&Array.isArray(r)&&r.length>0&&w.programas&&k(e=>({...e,programas:""}))};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(i,{className:"h-6 w-6 text-pink-600"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:f?"Editar ONG":"Cadastrar ONG"})]}),e.jsx(s,{className:"bg-gray-100 text-gray-700 hover:bg-gray-200",onClick:()=>p(-1),children:"Voltar"})]}),e.jsxs(r,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.nome,onChange:e=>O("nome",e.target.value),placeholder:"Nome da ONG",spellCheck:"false"}),w.nome&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.nome})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CNPJ"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.cnpj||"",onChange:e=>O("cnpj",e.target.value),placeholder:"00.000.000/0000-00"}),w.cnpj&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.cnpj})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome do Líder"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.nome_lider||"",onChange:e=>A(a=>({...a,nome_lider:e.target.value})),placeholder:"Nome do líder responsável",spellCheck:"false"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Endereço"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.endereco||"",onChange:e=>O("endereco",e.target.value),placeholder:"Rua, número",spellCheck:"false"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cidade"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.cidade||"",onChange:e=>O("cidade",e.target.value),placeholder:"Cidade",spellCheck:"false"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Estado"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.estado||"",onChange:e=>O("estado",e.target.value),placeholder:"UF"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CEP"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.cep||"",onChange:e=>O("cep",e.target.value),onBlur:()=>(async e=>{const a=(e||"").replace(/\D/g,"");if(8===a.length){y(!0),C(null);try{const e=await fetch(`https://viacep.com.br/ws/${a}/json/`),r=await e.json();if(null==r?void 0:r.erro)return void C("CEP não encontrado.");A(e=>({...e,endereco:[null==r?void 0:r.logradouro,null==r?void 0:r.bairro].filter(Boolean).join(", "),cidade:(null==r?void 0:r.localidade)||e.cidade,estado:(null==r?void 0:r.uf)||e.estado}))}catch(r){C("Erro ao buscar endereço.")}finally{y(!1)}}else C("CEP inválido")})(B.cep||""),placeholder:"00000-000"}),b&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Buscando endereço pelo CEP..."}),N&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:N}),w.cep&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.cep})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Telefone"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.telefone||"",onChange:e=>O("telefone",e.target.value),placeholder:"(00) 00000-0000"}),w.telefone&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.telefone})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.email||"",onChange:e=>O("email",e.target.value),placeholder:"contato@ong.org"}),w.email&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.email})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Regional"}),e.jsxs("select",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.regional,onChange:e=>O("regional",e.target.value),children:[e.jsx("option",{value:"nacional",children:"Nacional"}),e.jsx("option",{value:"comercial",children:"Comercial"}),e.jsx("option",{value:"centro_oeste",children:"Centro-Oeste"}),e.jsx("option",{value:"mg_es",children:"MG/ES"}),e.jsx("option",{value:"nordeste_1",children:"Nordeste 1"}),e.jsx("option",{value:"nordeste_2",children:"Nordeste 2"}),e.jsx("option",{value:"norte",children:"Norte"}),e.jsx("option",{value:"rj",children:"RJ"}),e.jsx("option",{value:"sp",children:"SP"}),e.jsx("option",{value:"sul",children:"Sul"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Programas"}),e.jsx("div",{className:"space-y-2",children:["as_maras","microcredito","decolagem"].map(a=>{var r;return e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"mr-2 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded",checked:(null==(r=B.programas)?void 0:r.includes(a))||!1,onChange:e=>{e.target.checked?O("programas",[...B.programas||[],a]):O("programas",(B.programas||[]).filter(e=>e!==a))}}),e.jsx("span",{className:"text-sm text-gray-700",children:"as_maras"===a?"As Maras":"microcredito"===a?"Microcrédito":"Decolagem"})]},a)})}),0===((null==(u=B.programas)?void 0:u.length)||0)&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Selecione pelo menos um programa"})]}),f&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("select",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.status||"ativa",onChange:e=>O("status",e.target.value),children:[e.jsx("option",{value:"ativa",children:"Ativa"}),e.jsx("option",{value:"inativa",children:"Inativa"}),e.jsx("option",{value:"evadida",children:"Evadida"})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Documentos"}),e.jsx("input",{type:"file",multiple:!0,onChange:e=>(e=>{if(!e)return;E(null);const a=["application/pdf","image/jpeg","image/png"],r=Array.from(e);r.some(e=>!a.includes(e.type))?E("Tipo de arquivo não permitido. Apenas PDF, JPG e PNG."):r.some(e=>e.size>10485760)?E("Arquivo excede o limite de 10MB."):A(e=>{const a=[...e.documentos||[],...r];return a.length>10?(E("Máximo de 10 arquivos permitidos."),e):{...e,documentos:a}})})(e.target.files),className:"w-full"}),$&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:$}),Boolean(B.documentos&&B.documentos.length)&&e.jsx("ul",{className:"mt-2 space-y-2",children:(B.documentos||[]).map((a,r)=>{const s="string"==typeof a?a:a.name;return e.jsxs("li",{className:"flex items-center justify-between text-sm text-gray-700 bg-gray-50 px-3 py-2 rounded",children:[e.jsx("span",{className:"truncate mr-3",children:s}),e.jsx("button",{type:"button",className:"text-red-600 hover:underline",onClick:()=>{return e=r,A(a=>({...a,documentos:(a.documentos||[]).filter((a,r)=>r!==e)})),void E(null);var e},children:"Remover"})]},`${s}-${r}`)})})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Observações"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:B.observacoes||"",onChange:e=>O("observacoes",e.target.value),placeholder:"Notas adicionais"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx(s,{className:"bg-gray-200 text-gray-800 hover:bg-gray-300",onClick:()=>p(-1),children:"Cancelar"}),e.jsxs(s,{className:"bg-pink-600 hover:bg-pink-700 text-white",onClick:async()=>{if((()=>{const e={};return B.nome&&""!==B.nome.trim()||(e.nome="Nome é obrigatório"),B.programas&&0!==B.programas.length||(e.programas="Selecione pelo menos um programa"),[["cnpj",B.cnpj||""],["cep",B.cep||""],["telefone",B.telefone||""],["email",B.email||""]].forEach(([a,r])=>{e[a]=I(a,r)}),k(e),Object.values(e).every(e=>!e)})()){v(!0);try{const e=(B.documentos||[]).map(e=>"string"==typeof e?e:e.name);if(f&&x){const a={nome:B.nome,cnpj:B.cnpj,endereco:B.endereco,cidade:B.cidade,estado:B.estado,cep:B.cep,telefone:B.telefone,email:B.email,regional:B.regional,programas:B.programas,status:B.status,observacoes:B.observacoes,nome_lider:B.nome_lider,documentos:e};await t.updateInstituicao(x,a),S("Instituição atualizada com sucesso!")}else{const a={nome:B.nome,cnpj:B.cnpj,endereco:B.endereco,cidade:B.cidade,estado:B.estado,cep:B.cep,telefone:B.telefone,email:B.email,regional:B.regional,programas:B.programas,observacoes:B.observacoes,nome_lider:B.nome_lider,documentos:e,status:"ativa"};await t.createInstituicao(a),S("Instituição cadastrada com sucesso!")}p("/ongs")}catch(e){_(e instanceof Error?e.message:"Erro ao salvar instituição")}finally{v(!1)}}},disabled:j,children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),j?"Salvando...":f?"Atualizar ONG":"Salvar ONG"]})]})]})]})}export{m as default};

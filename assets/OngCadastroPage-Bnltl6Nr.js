import{j as e}from"./ui-C_BmRRy8.js";import{r}from"./vendor-Psgnp9ei.js";import{C as a}from"./Card-C21MRrmW.js";import{B as s}from"./Button-DjYkO9ZW.js";import{g as o,I as t}from"./index-_MdAt-zn.js";import{a as l,u as n,d as c}from"./router-DVMx2JKX.js";import{B as i,_ as d}from"./icons-sb5RvF5O.js";import"./query-BI71cv7L.js";import"./supabase-CfsjXCJe.js";import"./forms-BADiA78i.js";import"./utils-CwAUyRUs.js";import"./charts-C4lFoNLr.js";function m(){var m,u;const p=l(),g=n(),{id:x}=c(),f=!!x,h=null==(m=g.state)?void 0:m.ong,[j,v]=r.useState(!1),[b,y]=r.useState(!1),[N,C]=r.useState(null),[w,k]=r.useState({}),[$,E]=r.useState(null),{showSuccess:_,showError:S}=o(),P=r.useMemo(()=>{if(f&&h)return h.regional;return new URLSearchParams(g.search).get("regional")||"nacional"},[g.search,f,h]),[O,B]=r.useState({nome:"",cnpj:"",endereco:"",cidade:"",estado:"",cep:"",telefone:"",email:"",regional:P,programas:[],status:"ativa",observacoes:"",nome_lider:"",documentos:[]});r.useEffect(()=>{if(f&&h)B(h);else if(f&&x){(async()=>{try{const e=await t.getInstituicaoById(x);B({nome:e.nome,cnpj:e.cnpj,endereco:e.endereco,cidade:e.cidade,estado:e.estado,cep:e.cep,telefone:e.telefone,email:e.email,regional:e.regional,programas:e.programas||(e.programa?[e.programa]:[]),status:e.status,observacoes:e.observacoes||"",nome_lider:e.nome_lider,documentos:e.documentos||[]})}catch(e){S("Erro ao carregar dados da instituição"),p("/ongs")}})()}},[f,h,x,S,p]);const A=e=>(e||"").replace(/\D/g,""),G=(e,r)=>{switch(e){case"cnpj":return(e=>{const r=A(e);return r&&14!==r.length?"CNPJ deve ter 14 dígitos":""})(r);case"cep":return(e=>{const r=A(e);return r?8===r.length?"":"CEP deve ter 8 dígitos":""})(r);case"telefone":return(e=>{const r=A(e).length;return r?10===r||11===r?"":"Telefone deve ter 10 ou 11 dígitos":""})(r);case"email":return(a=r)?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)?"":"Email inválido":"";default:return""}var a},I=(e,r)=>{let a=r;if("cnpj"===e&&"string"==typeof r&&(a=(e=>{const r=A(e).slice(0,14);let a=r;return r.length>2&&(a=r.replace(/^(\d{2})(\d)/,"$1.$2")),r.length>5&&(a=a.replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3")),r.length>8&&(a=a.replace(/\.(\d{3})(\d)/,".$1/$2")),r.length>12&&(a=a.replace(/\/(\d{4})(\d{1,2})$/,"/$1-$2")),a})(r)),"cep"===e&&"string"==typeof r&&(a=(e=>A(e).slice(0,8).replace(/^(\d{5})(\d)/,"$1-$2"))(r)),"telefone"===e&&"string"==typeof r&&(a=(e=>{const r=A(e).slice(0,11);return r.length<=10?r.replace(/^(\d{2})(\d)/,"($1) $2").replace(/(\d{4})(\d)/,"$1-$2"):r.replace(/^(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2")})(r)),B(r=>({...r,[e]:a})),["cnpj","cep","telefone","email"].includes(e)&&"string"==typeof a){const r=G(e,a);k(a=>({...a,[e]:r}))}"nome"===e&&w.nome&&k(e=>({...e,nome:""})),"programas"===e&&Array.isArray(a)&&a.length>0&&w.programas&&k(e=>({...e,programas:""}))};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(i,{className:"h-6 w-6 text-pink-600"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:f?"Editar ONG":"Cadastrar ONG"})]}),e.jsx(s,{className:"bg-gray-100 text-gray-700 hover:bg-gray-200",onClick:()=>p(-1),children:"Voltar"})]}),e.jsxs(a,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.nome,onChange:e=>I("nome",e.target.value),placeholder:"Nome da ONG",spellCheck:"false"}),w.nome&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.nome})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CNPJ"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.cnpj||"",onChange:e=>I("cnpj",e.target.value),placeholder:"00.000.000/0000-00"}),w.cnpj&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.cnpj})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome do Líder"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.nome_lider||"",onChange:e=>B(r=>({...r,nome_lider:e.target.value})),placeholder:"Nome do líder responsável",spellCheck:"false"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Endereço"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.endereco||"",onChange:e=>I("endereco",e.target.value),placeholder:"Rua, número",spellCheck:"false"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cidade"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.cidade||"",onChange:e=>I("cidade",e.target.value),placeholder:"Cidade",spellCheck:"false"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Estado"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.estado||"",onChange:e=>I("estado",e.target.value),placeholder:"UF"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CEP"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.cep||"",onChange:e=>I("cep",e.target.value),onBlur:()=>(async e=>{const r=(e||"").replace(/\D/g,"");if(8===r.length){y(!0),C(null);try{const e=await fetch(`https://viacep.com.br/ws/${r}/json/`),a=await e.json();if(null==a?void 0:a.erro)return void C("CEP não encontrado.");B(e=>({...e,endereco:[null==a?void 0:a.logradouro,null==a?void 0:a.bairro].filter(Boolean).join(", "),cidade:(null==a?void 0:a.localidade)||e.cidade,estado:(null==a?void 0:a.uf)||e.estado}))}catch(a){C("Erro ao buscar endereço.")}finally{y(!1)}}else C("CEP inválido")})(O.cep||""),placeholder:"00000-000"}),b&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Buscando endereço pelo CEP..."}),N&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:N}),w.cep&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.cep})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Telefone"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.telefone||"",onChange:e=>I("telefone",e.target.value),placeholder:"(00) 00000-0000"}),w.telefone&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.telefone})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.email||"",onChange:e=>I("email",e.target.value),placeholder:"contato@ong.org"}),w.email&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:w.email})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Regional"}),e.jsxs("select",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.regional,onChange:e=>I("regional",e.target.value),children:[e.jsx("option",{value:"nacional",children:"Nacional"}),e.jsx("option",{value:"comercial",children:"Comercial"}),e.jsx("option",{value:"centro_oeste",children:"Centro-Oeste"}),e.jsx("option",{value:"mg_es",children:"MG/ES"}),e.jsx("option",{value:"nordeste_1",children:"Nordeste 1"}),e.jsx("option",{value:"nordeste_2",children:"Nordeste 2"}),e.jsx("option",{value:"norte",children:"Norte"}),e.jsx("option",{value:"rj",children:"RJ"}),e.jsx("option",{value:"sp",children:"SP"}),e.jsx("option",{value:"sul",children:"Sul"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Programas"}),e.jsx("div",{className:"space-y-2",children:["as_maras","microcredito","decolagem"].map(r=>{var a;return e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",className:"mr-2 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded",checked:(null==(a=O.programas)?void 0:a.includes(r))||!1,onChange:e=>{e.target.checked?I("programas",[...O.programas||[],r]):I("programas",(O.programas||[]).filter(e=>e!==r))}}),e.jsx("span",{className:"text-sm text-gray-700",children:"as_maras"===r?"As Maras":"microcredito"===r?"Microcrédito":"Decolagem"})]},r)})}),0===((null==(u=O.programas)?void 0:u.length)||0)&&-e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Selecione pelo menos um programa"})+null]}),f&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("select",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.status||"ativa",onChange:e=>I("status",e.target.value),children:[e.jsx("option",{value:"ativa",children:"Ativa"}),e.jsx("option",{value:"inativa",children:"Inativa"}),e.jsx("option",{value:"evadida",children:"Evadida"})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Documentos"}),e.jsx("input",{type:"file",multiple:!0,onChange:e=>(e=>{if(!e)return;E(null);const r=["application/pdf","image/jpeg","image/png"],a=Array.from(e);a.some(e=>!r.includes(e.type))?E("Tipo de arquivo não permitido. Apenas PDF, JPG e PNG."):a.some(e=>e.size>10485760)?E("Arquivo excede o limite de 10MB."):B(e=>{const r=[...e.documentos||[],...a];return r.length>10?(E("Máximo de 10 arquivos permitidos."),e):{...e,documentos:r}})})(e.target.files),className:"w-full"}),$&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:$}),Boolean(O.documentos&&O.documentos.length)&&e.jsx("ul",{className:"mt-2 space-y-2",children:(O.documentos||[]).map((r,a)=>{const s="string"==typeof r?r:r.name;return e.jsxs("li",{className:"flex items-center justify-between text-sm text-gray-700 bg-gray-50 px-3 py-2 rounded",children:[e.jsx("span",{className:"truncate mr-3",children:s}),e.jsx("button",{type:"button",className:"text-red-600 hover:underline",onClick:()=>{return e=a,B(r=>({...r,documentos:(r.documentos||[]).filter((r,a)=>a!==e)})),void E(null);var e},children:"Remover"})]},`${s}-${a}`)})})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Observações"}),e.jsx("input",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",value:O.observacoes||"",onChange:e=>I("observacoes",e.target.value),placeholder:"Notas adicionais"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx(s,{className:"bg-gray-200 text-gray-800 hover:bg-gray-300",onClick:()=>p(-1),children:"Cancelar"}),e.jsxs(s,{className:"bg-pink-600 hover:bg-pink-700 text-white",onClick:async()=>{var e;if((()=>{const e={};return[["cnpj",O.cnpj||""],["cep",O.cep||""],["telefone",O.telefone||""],["email",O.email||""]].forEach(([r,a])=>{e[r]=G(r,a)}),k(e),Object.values(e).every(e=>!e)})()){v(!0);try{const r=(O.documentos||[]).map(e=>"string"==typeof e?e:e.name);if(f&&x){const a={nome:O.nome,cnpj:O.cnpj,endereco:O.endereco,cidade:O.cidade,estado:O.estado,cep:O.cep,telefone:O.telefone,email:O.email,regional:O.regional,programas:O.programas,status:null==(e=O.status)?void 0:e.toLowerCase(),observacoes:O.observacoes,nome_lider:O.nome_lider,documentos:r},s=Object.fromEntries(Object.entries(a).filter(([e,r])=>null!=r&&("string"!=typeof r||""!==r.trim())));await t.updateInstituicao(x,s),_("Instituição atualizada com sucesso!")}else{const e={nome:O.nome,cnpj:O.cnpj,endereco:O.endereco,cidade:O.cidade,estado:O.estado,cep:O.cep,telefone:O.telefone,email:O.email,regional:O.regional,programas:O.programas,observacoes:O.observacoes,nome_lider:O.nome_lider,documentos:r,status:"ativa"};await t.createInstituicao(e),_("Instituição cadastrada com sucesso!")}p("/ongs")}catch(r){S(r instanceof Error?r.message:"Erro ao salvar instituição")}finally{v(!1)}}},disabled:j,children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),j?"Salvando...":f?"Atualizar ONG":"Salvar ONG"]})]})]})]})}export{m as default};
